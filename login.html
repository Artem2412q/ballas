<!doctype html>
<html lang="ru" data-theme="dark" data-root=".">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="–í—Ö–æ–¥ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è." />
  <title>Ballas ‚Äî –í—Ö–æ–¥</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <a class="skip" href="#main">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É</a>

  <div class="bg" aria-hidden="true">
    <div class="bg__blob bg__blob--1"></div>
    <div class="bg__blob bg__blob--2"></div>
    <div class="bg__blob bg__blob--3"></div>
    <div class="bg__mesh"></div>
    <div class="bg__pattern"></div>
    <div class="bg__vignette"></div>
  </div>

  <header class="topbar" id="topbar">
    <div class="progress" aria-hidden="true"><div class="progress__bar" id="scrollProgress"></div></div>
    <div class="wrap topbar__inner">
      <a class="brand" href="index.html" aria-label="Ballas ‚Äî –Ω–∞ –≥–ª–∞–≤–Ω—É—é">
        <span class="brand__mark" aria-hidden="true"></span>
        <span class="brand__text">
          <span class="brand__title">Ballas</span>
          <span class="brand__sub">Login ‚Ä¢ profile</span>
        </span>
      </a>
      <nav class="nav" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
        <a class="nav__link" href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
        <a class="nav__link" href="characters/index.html">–°–æ—Å—Ç–∞–≤</a>
        <a class="nav__link" href="profile.html">–ü—Ä–æ—Ñ–∏–ª—å</a>
      </nav>
      <div class="actions">
        <a class="btn btn--ghost" data-auth-link href="login.html">–í—Ö–æ–¥</a>
        <button class="btn btn--ghost" data-logout-btn type="button" hidden>–í—ã–π—Ç–∏</button>
        <button class="btn btn--ghost" id="themeBtn" type="button">üåô Dark</button>
      </div>
    </div>
  </header>

  <main id="main">
    <section class="section wrap" style="padding-top:22px">
      <div class="panel reveal" style="max-width:520px;margin:0 auto">
        <div class="panel__head">
          <div>
            <div class="panel__title">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>
            <div class="panel__sub">1 –∞–∫–∫–∞—É–Ω—Ç = 1 –ø–µ—Ä—Å–æ–Ω–∞–∂</div>
          </div>
          <span class="badge">auth</span>
        </div>

        <div class="filters" style="grid-template-columns:1fr; gap:10px">
          <input class="input" id="email" type="email" autocomplete="email" placeholder="Email" />
          <input class="input" id="password" type="password" autocomplete="current-password" placeholder="–ü–∞—Ä–æ–ª—å" />
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
          <button class="btn btn--primary" id="loginBtn" type="button">–í–æ–π—Ç–∏</button>
          <button class="btn btn--ghost" id="regBtn" type="button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>

        <div class="note" style="margin-top:12px">
          –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –≤—Ö–æ–¥ ‚Äî –∂–º–∏ ¬´–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è¬ª. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∞–Ω–∫–µ—Ç–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ.
        </div>
      </div>
    </section>
  </main>

  <script type="module" src="./auth-ui.js"></script>
  <script src="script.js"></script>
  <script type="module">
    import { isDemoMode, getDemoUser, setDemoUser } from './demo-store.js';

    const DEMO = isDemoMode();

    let auth = null;
    let signInWithEmailAndPassword = null;
    let createUserWithEmailAndPassword = null;

    if (!DEMO) {
      const cfg = await import('./firebase-config.js');
      auth = cfg.auth;
      const mod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
      signInWithEmailAndPassword = mod.signInWithEmailAndPassword;
      createUserWithEmailAndPassword = mod.createUserWithEmailAndPassword;
    }

    const $ = (id) => document.getElementById(id);

    const note = document.querySelector('.note');
    const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    // NOTE: In this GitHub-ready build we fall back to DEMO mode under file://,
    // so users can still register/login locally. We keep a small hint, but we
    // do NOT disable buttons.
    if (location.protocol === 'file:' && note) {
      note.textContent = '–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Å–∞–π—Ç –æ—Ç–∫—Ä—ã—Ç –∫–∞–∫ —Ñ–∞–π–ª (file://). –°–µ–π—á–∞—Å –≤–∫–ª—é—á—ë–Ω –¥–µ–º–æ‚Äë—Ä–µ–∂–∏–º (–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ). –î–ª—è Firebase‚Äë—Ä–µ–∂–∏–º–∞ –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ —Ö–æ—Å—Ç–∏–Ω–≥/—Å–µ—Ä–≤–µ—Ä.';
    }

    const setBusy = (busy) => {
      $('loginBtn').disabled = busy;
      $('regBtn').disabled = busy;
      $('loginBtn').style.opacity = busy ? '0.7' : '';
      $('regBtn').style.opacity = busy ? '0.7' : '';
    };

    const readCreds = () => {
      const email = ($('email').value || '').trim();
      const password = $('password').value || '';
      if (!emailRe.test(email)) {
        throw new Error('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email (–Ω–∞–ø—Ä–∏–º–µ—Ä name@gmail.com).');
      }
      if (password.length < 6) {
        throw new Error('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤.');
      }
      return { email, password };
    };

    $('loginBtn').addEventListener('click', async () => {
      try {
        setBusy(true);
        const { email, password } = readCreds();
        if (DEMO) {
          const u = getDemoUser();
          if (!u || u.email !== email) throw new Error('–î–µ–º–æ‚Äë—Ä–µ–∂–∏–º GitHub Pages: —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ ¬´–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è¬ª (–ª–æ–∫–∞–ª—å–Ω–æ), –∑–∞—Ç–µ–º ¬´–í–æ–π—Ç–∏¬ª.');
          location.href = 'profile.html';
        } else {
          await signInWithEmailAndPassword(auth, email, password);
          location.href = 'profile.html';
        }
      } catch (e) {
        console.error('Login failed:', e);
        const msg = (e?.code === 'auth/invalid-credential')
          ? '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å.'
          : (e?.code === 'auth/operation-not-allowed')
            ? '–í Firebase –Ω–µ –≤–∫–ª—é—á—ë–Ω —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞ Email/Password. –û—Ç–∫—Ä–æ–π Firebase Console ‚Üí Authentication ‚Üí Sign-in method ‚Üí Email/Password ‚Üí Enable.'
            : (e?.code === 'auth/network-request-failed')
              ? '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/VPN/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.'
          : (e?.message || String(e));
        if (note) note.textContent = msg;
        else alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + msg);
      } finally {
        setBusy(false);
      }
    });

    $('regBtn').addEventListener('click', async () => {
      try {
        setBusy(true);
        const { email, password } = readCreds();
        if (DEMO) {
          setDemoUser(email);
          location.href = 'profile.html';
        } else {
          await createUserWithEmailAndPassword(auth, email, password);
          location.href = 'profile.html';
        }
      } catch (e) {
        console.error('Registration failed:', e);
        const msg = (e?.code === 'auth/email-already-in-use')
          ? '–≠—Ç–æ—Ç email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π ¬´–í–æ–π—Ç–∏¬ª.'
          : (e?.code === 'auth/invalid-email')
            ? 'Email –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç.'
            : (e?.code === 'auth/operation-not-allowed')
              ? '–í Firebase –Ω–µ –≤–∫–ª—é—á—ë–Ω —Å–ø–æ—Å–æ–± —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Email/Password. –û—Ç–∫—Ä–æ–π Firebase Console ‚Üí Authentication ‚Üí Sign-in method ‚Üí Email/Password ‚Üí Enable.'
              : (e?.code === 'auth/network-request-failed')
                ? '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/VPN/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.'
            : (e?.code === 'auth/unauthorized-domain')
              ? '–î–æ–º–µ–Ω –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω –≤ Firebase Auth. –î–æ–±–∞–≤—å –¥–æ–º–µ–Ω —Å–∞–π—Ç–∞ –≤ Authentication ‚Üí Settings ‚Üí Authorized domains.'
              : (e?.message || String(e));
        if (note) note.textContent = msg;
        else alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + msg);
      } finally {
        setBusy(false);
      }
    });
  </script>
</body>
</html>
