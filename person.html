<!doctype html>
<html lang="ru" data-theme="dark" data-root=".">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="–ü—Ä–æ—Ñ–∏–ª—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞." />
  <title>Ballas ‚Äî –ü–µ—Ä—Å–æ–Ω–∞–∂</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <a class="skip" href="#main">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É</a>

  <div class="bg" aria-hidden="true">
    <div class="bg__blob bg__blob--1"></div>
    <div class="bg__blob bg__blob--2"></div>
    <div class="bg__blob bg__blob--3"></div>
    <div class="bg__mesh"></div>
    <div class="bg__pattern"></div>
    <div class="bg__vignette"></div>
  </div>

  <header class="topbar" id="topbar">
    <div class="progress" aria-hidden="true"><div class="progress__bar" id="scrollProgress"></div></div>

    <div class="wrap topbar__inner">
      <a class="brand" href="index.html" aria-label="Ballas ‚Äî –Ω–∞ –≥–ª–∞–≤–Ω—É—é">
        <span class="brand__mark" aria-hidden="true"></span>
        <span class="brand__text">
          <span class="brand__title">Ballas</span>
          <span class="brand__sub">Character ‚Ä¢ page</span>
        </span>
      </a>

      <nav class="nav" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
        <a class="nav__link" href="characters/index.html">–°–æ—Å—Ç–∞–≤</a>
        <a class="nav__link" href="cases/index.html">–ö–µ–π—Å—ã</a>
        <a class="nav__link" href="rp/index.html">RP‚Äë–¥–æ—Å—å–µ</a>
      </nav>

      <div class="actions">
        <a class="btn btn--ghost" data-auth-link href="login.html">–í—Ö–æ–¥</a>
        <button class="btn btn--ghost" data-logout-btn type="button" hidden>–í—ã–π—Ç–∏</button>
        <button class="btn btn--ghost" id="themeBtn" type="button">üåô Dark</button>
        <button class="iconBtn" id="menuBtn" type="button" aria-label="–ú–µ–Ω—é" aria-expanded="false" aria-controls="mobileMenu">
          <span class="iconBtn__bar"></span>
          <span class="iconBtn__bar"></span>
          <span class="iconBtn__bar"></span>
        </button>
      </div>
    </div>

    <div class="mobileMenu" id="mobileMenu" hidden>
      <div class="wrap mobileMenu__inner">
        <a class="mobileMenu__link" href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
        <a class="mobileMenu__link" href="characters/index.html">–°–æ—Å—Ç–∞–≤</a>
        <a class="mobileMenu__link" href="profile.html">–ü—Ä–æ—Ñ–∏–ª—å</a>
      </div>
    </div>
  </header>

  <main id="main">
    <section class="section wrap" style="padding-top:24px">
      <div class="panel reveal" id="state">
        <div class="panel__head">
          <div>
            <div class="panel__title">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è‚Ä¶</div>
            <div class="panel__sub">database</div>
          </div>
          <span class="badge">db</span>
        </div>
        <p class="p">–ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—É—Å—Ç–∞—è ‚Äî –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ–∑–¥–∞–Ω –≤ –ø—Ä–æ—Ñ–∏–ª–µ, –∞ —Å—Å—ã–ª–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç slug.</p>
      </div>

      <div id="profile" class="grid2" style="display:none"></div>
    </section>

    <footer class="footer">
      <div class="wrap footer__inner">
        <div>Ballas ‚Ä¢ Person</div>
        <button class="btn btn--ghost" id="themeBtn2" type="button">–¢–µ–º–∞</button>
      </div>
    </footer>
  </main>

  <button class="btn btn--primary toTop" id="toTop" type="button" aria-label="–ù–∞–≤–µ—Ä—Ö">‚Üë –ù–∞–≤–µ—Ä—Ö</button>

  <script type="module">
    import { isDemoMode, getDemoCharacterBySlug, getDemoCharacterByUid } from './demo-store.js';

    const DEMO = isDemoMode();

    let db = null;
    let collection = null, query = null, where = null, limit = null, getDocs = null, doc = null, getDoc = null;
    if (!DEMO) {
      const cfg = await import('./firebase-config.js');
      db = cfg.db;
      const fsMod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
      collection = fsMod.collection;
      query = fsMod.query;
      where = fsMod.where;
      limit = fsMod.limit;
      getDocs = fsMod.getDocs;
      doc = fsMod.doc;
      getDoc = fsMod.getDoc;
    }

    const slug = new URLSearchParams(location.search).get('slug') || '';

    async function load() {
      if (!slug) {
        state.querySelector('.panel__title').textContent = '–ù–µ —É–∫–∞–∑–∞–Ω slug';
        state.querySelector('.panel__sub').textContent = 'person.html?slug=...';
        return;
      }

      let c = null;
      try {
        if (DEMO) {
          if (slug.startsWith('uid-') && slug.length > 4) {
            const uid = slug.slice(4);
            c = getDemoCharacterByUid(uid);
          }
          if (!c) c = getDemoCharacterBySlug(slug);
        } else {
          if (slug.startsWith('uid-') && slug.length > 4) {
            const uid = slug.slice(4);
            const s = await getDoc(doc(db, 'characters', uid));
            if (s.exists()) c = s.data();
          }
          if (!c) {
            const q = query(collection(db, 'characters'), where('slug', '==', slug), limit(1));
            const snap = await getDocs(q);
            if (!snap.empty) c = snap.docs[0].data();
          }
        }
      } catch (e) {
        console.error('Firestore load failed:', e);
        const code = e?.code || '';
        state.querySelector('.panel__title').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        state.querySelector('.panel__sub').textContent = (code === 'permission-denied')
          ? '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Firestore (–ø—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞ —á—Ç–µ–Ω–∏—è)'
          : '–ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø—Ä–∞–≤–∏–ª–∞ Firebase';
        return;
      }

      if (!c) {
        state.querySelector('.panel__title').textContent = '–ü–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω';
        state.querySelector('.panel__sub').textContent = slug;
        return;
      }
      state.style.display = 'none';
      profile.style.display = '';

      const photo = c.photoUrl || c.photo || '';
      const tags = Array.isArray(c.tags) ? c.tags : (typeof c.tags === 'string' ? c.tags.split(',').map(s=>s.trim()).filter(Boolean) : []);
      const rp = c.rp || {};

      const dobLabel = c.dob ? escapeHtml(c.dob) : '18+';
      const quick = [
        { k: '–†–æ–ª—å', v: c.role || '‚Äî' },
        { k: '–°–µ—Ç', v: c.set || 'Davis' },
        { k: 'DOB', v: c.dob ? fmtDate(c.dob) : '‚Äî' },
      ];

      const rp2 = {
        preface: rp.preface,
        historyStart: rp.historyStart,
        historyMiddle: rp.historyMiddle,
        bridge: rp.bridge,
        devPre2026: rp.devPre2026 || rp.devBefore2026,
        dev2026: rp.dev2026,
        plotStart2026: rp.plotStart2026,
        morality: rp.morality,
        tasks: rp.tasks,
        message: rp.message,
        funding: rp.funding,
        cops: rp.cops,
        climax: rp.climax,
        ops2026: rp.ops2026,
      };

      profile.innerHTML = `
        <article class="panel reveal">
          <div class="panel__head">
            <div>
              <div class="panel__title">${escapeHtml(c.name || '‚Äî')} <span class="small">${escapeHtml(c.alias || '')}</span></div>
              <div class="panel__sub">${escapeHtml(c.role || '‚Äî')} ‚Ä¢ ${escapeHtml(c.set || 'Davis')}</div>
            </div>
            <span class="badge">${dobLabel}</span>
          </div>

          <div class="personHero" style="margin-top:12px">
            <div class="personHero__media">
              ${photo ? `<img class="personHero__img" alt="–§–æ—Ç–æ –∞–Ω—Ñ–∞—Å" src="${photo}">` : `<div class="personHero__ph">–§–æ—Ç–æ
              <span class="small">(–ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)</span></div>`}
            </div>
            <div class="personHero__meta">
              <div class="kv kv--wide">
                ${quick.map(row => `
                  <div>
                    <div class="kv__k">${escapeHtml(row.k)}</div>
                    <div class="kv__v">${escapeHtml(row.v)}</div>
                  </div>
                `).join('')}
              </div>

              ${tags.length ? `<div class="metaRow" style="margin-top:12px">${tags.map(t=>`<span class="metaPill">#${escapeHtml(t)}</span>`).join('')}</div>` : ''}

              ${c.bio ? `<p class="p" style="margin-top:12px">${escapeHtml(c.bio)}</p>` : ''}
            </div>
          </div>
        </article>

        <article class="panel reveal">
          <div class="panel__head">
            <div>
              <div class="panel__title">RP‚Äë–∞–Ω–∫–µ—Ç–∞</div>
              <div class="panel__sub">—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∏—Å—Ç–æ—Ä–∏—è, –¥–µ–π—Å—Ç–≤–∏—è –≤ 2026</div>
            </div>
            <span class="badge">rp</span>
          </div>

          ${acc('–ü—Ä–µ–¥–∏—Å–ª–æ–≤–∏–µ', rp2.preface, true)}
          ${acc('–ò—Å—Ç–æ—Ä–∏—è ‚Äî –Ω–∞—á–∞–ª–æ', rp2.historyStart)}
          ${acc('–ò—Å—Ç–æ—Ä–∏—è ‚Äî —Å–µ—Ä–µ–¥–∏–Ω–∞', rp2.historyMiddle)}
          ${acc('–°–∫–ª–µ–π–∫–∞', rp2.bridge)}
          ${acc('–†–∞–∑–≤–∏—Ç–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–æ 2026', rp2.devPre2026)}
          ${acc('–†–∞–∑–≤–∏—Ç–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ 2026', rp2.dev2026)}
          ${acc('–ù–∞—á–∞–ª–æ —Å—é–∂–µ—Ç–∞ 2026', rp2.plotStart2026)}
          ${acc('–ú–æ—Ä–∞–ª—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏', rp2.morality)}
          ${acc('–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏', rp2.tasks)}
          ${acc('–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Å—ã–ª', rp2.message)}
          ${acc('–§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ', rp2.funding)}
          ${acc('–û—Ç–Ω–æ—à–µ–Ω–∏–µ —Å –∫–æ–ø–∞–º–∏', rp2.cops)}
          ${acc('–ö—É–ª—å–º–∏–Ω–∞—Ü–∏—è', rp2.climax)}
          ${acc('–û–ø–µ—Ä–∞—Ü–∏–∏ 2026', rp2.ops2026)}
        </article>
      `;
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
    }
    function block(title, value){
      if (!value) return '';
      return `<div class="mini" style="margin-top:12px"><div class="mini__k">${escapeHtml(title)}</div><div class="mini__v">${escapeHtml(value).replace(/\n/g,'<br>')}</div></div>`;
    }

    function acc(title, value, open = false){
      if (!value) return '';
      return `
        <details class="acc" ${open ? 'open' : ''}>
          <summary class="acc__sum">${escapeHtml(title)}</summary>
          <div class="acc__body">${escapeHtml(value).replace(/\n/g,'<br>')}</div>
        </details>
      `;
    }

    function fmtDate(iso){
      try{
        const d = new Date(iso);
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yy = d.getFullYear();
        return `${dd}.${mm}.${yy}`;
      } catch { return String(iso || ''); }
    }

    load().catch((e) => {
      console.error(e);
      state.querySelector('.panel__title').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
      state.querySelector('.panel__sub').textContent = '–ü—Ä–æ–≤–µ—Ä—å Firestore rules –∏ –∫–æ–Ω—Ñ–∏–≥.';
    });
  </script>

  <script type="module" src="./auth-ui.js"></script>
  <script src="script.js"></script>
</body>
</html>
