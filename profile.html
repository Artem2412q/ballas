<!doctype html>
<html lang="ru" data-theme="dark" data-root="." data-auth-required="1">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="–õ–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å: RP‚Äë–∞–Ω–∫–µ—Ç–∞ –∏ —Ñ–æ—Ç–æ." />
  <title>Ballas ‚Äî –ü—Ä–æ—Ñ–∏–ª—å</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <a class="skip" href="#main">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É</a>

  <div class="bg" aria-hidden="true">
    <div class="bg__blob bg__blob--1"></div>
    <div class="bg__blob bg__blob--2"></div>
    <div class="bg__blob bg__blob--3"></div>
    <div class="bg__mesh"></div>
    <div class="bg__pattern"></div>
    <div class="bg__vignette"></div>
  </div>

  <header class="topbar" id="topbar">
    <div class="progress" aria-hidden="true"><div class="progress__bar" id="scrollProgress"></div></div>
    <div class="wrap topbar__inner">
      <a class="brand" href="index.html" aria-label="Ballas ‚Äî –Ω–∞ –≥–ª–∞–≤–Ω—É—é">
        <span class="brand__mark" aria-hidden="true"></span>
        <span class="brand__text">
          <span class="brand__title">Ballas</span>
          <span class="brand__sub">Profile ‚Ä¢ one account = one character</span>
        </span>
      </a>

      <nav class="nav" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
        <a class="nav__link" href="index.html#about">–û–±–∑–æ—Ä</a>
        <a class="nav__link" href="index.html#hood">–†–∞–π–æ–Ω</a>
        <a class="nav__link" href="characters/index.html">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</a>
        <a class="nav__link" href="cases/index.html">–ö–µ–π—Å—ã</a>
        <a class="nav__link" href="rp/index.html">RP‚Äë–¥–æ—Å—å–µ</a>
      </nav>

      <div class="actions">
        <button class="btn btn--ghost" id="themeBtn" type="button">üåô Dark</button>
        <a class="btn btn--ghost" data-auth-link href="login.html">–í—Ö–æ–¥</a>
        <button class="btn btn--ghost" data-logout-btn type="button" hidden>–í—ã–π—Ç–∏</button>

        <button class="iconBtn" id="menuBtn" type="button" aria-label="–ú–µ–Ω—é" aria-expanded="false" aria-controls="mobileMenu">
          <span class="iconBtn__bar"></span>
          <span class="iconBtn__bar"></span>
          <span class="iconBtn__bar"></span>
        </button>
      </div>
    </div>

    <div class="mobileMenu" id="mobileMenu" hidden>
      <div class="wrap mobileMenu__inner">
        <a class="mobileMenu__link" href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
        <a class="mobileMenu__link" href="characters/index.html">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</a>
        <a class="mobileMenu__link" href="cases/index.html">–ö–µ–π—Å—ã</a>
        <a class="mobileMenu__link" href="rp/index.html">RP‚Äë–¥–æ—Å—å–µ</a>
        <div class="mobileMenu__hint">–ú–µ–Ω—é –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ –∫–ª–∏–∫—É –Ω–∞ –ø—É–Ω–∫—Ç –∏–ª–∏ –ø–æ Esc.</div>
      </div>
    </div>
  </header>

  <main id="main">
    <section class="section wrap">
      <div class="panel reveal">
        <div class="panel__head">
          <div>
            <div class="panel__title">–õ–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</div>
            <div class="panel__sub">RP‚Äë–∞–Ω–∫–µ—Ç–∞ + —Ñ–æ—Ç–æ –∞–Ω—Ñ–∞—Å ‚Ä¢ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ database</div>
          </div>
          <span class="badge">profile</span>
        </div>

        <div class="note" id="statusNote" style="margin-bottom:14px">–ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é‚Ä¶</div>

        <form id="profileForm" class="grid2" autocomplete="off">
          <label class="field">
            <span class="field__label">–ò–º—è (–∞–Ω–≥–ª.)</span>
            <input class="input" id="firstName" required placeholder="Marcus" />
          </label>

          <label class="field">
            <span class="field__label">–§–∞–º–∏–ª–∏—è (–∞–Ω–≥–ª.)</span>
            <input class="input" id="lastName" required placeholder="Coleman" />
          </label>

          <label class="field">
            <span class="field__label">Alias</span>
            <input class="input" id="alias" required placeholder="" />
          </label>

          <label class="field">
            <span class="field__label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (18+)</span>
            <input class="input" id="dob" type="date" required />
          </label>

          <label class="field" style="grid-column:1/-1">
            <span class="field__label">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</span>
            <input class="input" id="tags" placeholder="davis, diplomacy, intel" />
          </label>

          <label class="field" style="grid-column:1/-1">
            <span class="field__label">–§–æ—Ç–æ –∞–Ω—Ñ–∞—Å</span>
            <input class="input" id="photo" type="file" accept="image/*" />
            <div class="small" style="margin-top:6px">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –∫–≤–∞–¥—Ä–∞—Ç, 512√ó512. –§–æ—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ Storage.</div>
            <div id="photoPreview" style="margin-top:10px"></div>
          </label>

          <div class="panel" style="grid-column:1/-1">
            <div class="panel__head">
              <div>
                <div class="panel__title">–ú–∞—Å—à—Ç–∞–±–Ω–∞—è RP‚Äë–∞–Ω–∫–µ—Ç–∞</div>
                <div class="panel__sub">—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è 2026 –∏ –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏–∏</div>
              </div>
              <span class="badge">sheet</span>
            </div>

            <div class="stack">
              <label class="field">
                <span class="field__label">–ü—Ä–µ–¥–∏—Å–ª–æ–≤–∏–µ</span>
                <textarea class="textarea" id="preface" rows="4" placeholder="–ö–æ—Ä–æ—Ç–∫–æ: –∫—Ç–æ —Ç—ã, –≤ —á—ë–º —Ç–≤–æ–π —Å—Ç–µ—Ä–∂–µ–Ω—å, —á—Ç–æ —Ç—ã –±–µ—Ä–µ–∂—ë—à—å."></textarea>
              </label>

              <label class="field">
                <span class="field__label">–ò—Å—Ç–æ—Ä–∏—è: –Ω–∞—á–∞–ª–æ</span>
                <textarea class="textarea" id="historyStart" rows="5"></textarea>
              </label>

              <label class="field">
                <span class="field__label">–ò—Å—Ç–æ—Ä–∏—è: —Å–µ—Ä–µ–¥–∏–Ω–∞</span>
                <textarea class="textarea" id="historyMiddle" rows="5"></textarea>
              </label>

              <label class="field">
                <span class="field__label">–°–∫–ª–µ–π–∫–∞ (–ø–æ–≤–æ—Ä–æ—Ç/–ø–µ—Ä–µ—Ö–æ–¥)</span>
                <textarea class="textarea" id="bridge" rows="4"></textarea>
              </label>

              <label class="field">
                <span class="field__label">–†–∞–∑–≤–∏—Ç–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–æ 2026 –≥–æ–¥–∞</span>
                <textarea class="textarea" id="devPre2026" rows="5"></textarea>
              </label>

              <label class="field">
                <span class="field__label">–†–∞–∑–≤–∏—Ç–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ 2026 –≥–æ–¥—É</span>
                <textarea class="textarea" id="dev2026" rows="5"></textarea>
              </label>

              <label class="field">
                <span class="field__label">–ù–∞—á–∞–ª–æ —Å—é–∂–µ—Ç–∞ –≤ 2026: –∫–∞–∫ –¥–µ–π—Å—Ç–≤—É–µ–º</span>
                <textarea class="textarea" id="plotStart2026" rows="5" placeholder="–¢–æ–Ω: —Å–ø–æ–∫–æ–π–Ω–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞; –±–µ–∑ –∞–≥—Ä–µ—Å—Å–∏–∏, –Ω–æ –µ—Å–ª–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∏ –¥–∞–≤—è—Ç ‚Äî Ballas –æ—Ç–≤–µ—á–∞–µ—Ç –∏ –æ—Ç—Å—Ç–∞–∏–≤–∞–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å—ã."></textarea>
              </label>

              <label class="field">
                <span class="field__label">–ú–æ—Ä–∞–ª—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ (—Ç–≤–æ–π –≤–∑–≥–ª—è–¥)</span>
                <textarea class="textarea" id="morality" rows="4"></textarea>
              </label>

              <label class="field">
                <span class="field__label">–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∏ —Ñ—É–Ω–∫—Ü–∏–∏</span>
                <textarea class="textarea" id="tasks" rows="4"></textarea>
              </label>

              <label class="field">
                <span class="field__label">–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Å—ã–ª</span>
                <textarea class="textarea" id="message" rows="3"></textarea>
              </label>

              <label class="field">
                <span class="field__label">–§–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ–¥—Ä–æ–±–Ω–æ)</span>
                <textarea class="textarea" id="funding" rows="6" placeholder="–û–ø–∏—à–∏ –ª–µ–≥–∞–ª—å–Ω—ã–µ —Ñ–∞—Å–∞–¥—ã, —Å—Ö–µ–º—ã –¥–æ—Ö–æ–¥–∞ –∏ –∑–∞–∫–∞–∑–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∫–∞–∫ —Å—é–∂–µ—Ç–Ω—ã–µ –ø–æ—Ä—É—á–µ–Ω–∏—è (–±–µ–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π)."></textarea>
              </label>

              <label class="field">
                <span class="field__label">–û—Ç–Ω–æ—à–µ–Ω–∏–µ —Å –∫–æ–ø–∞–º–∏ (—Å–ø–æ–∫–æ–π–Ω–æ–µ)</span>
                <textarea class="textarea" id="cops" rows="3"></textarea>
              </label>

              <label class="field">
                <span class="field__label">–ö—É–ª—å–º–∏–Ω–∞—Ü–∏—è (–ª–∏—á–Ω–∞—è/–≥—Ä—É–ø–ø–æ–≤–∞—è)</span>
                <textarea class="textarea" id="climax" rows="4"></textarea>
              </label>

              <label class="field">
                <span class="field__label">–û–ø–µ—Ä–∞—Ü–∏–∏ 2026 (—Å—é–∂–µ—Ç–Ω—ã–µ –ª–∏–Ω–∏–∏)</span>
                <textarea class="textarea" id="ops2026" rows="6" placeholder="–õ–∏–Ω–∏–∏: –¥–∞–≤–ª–µ–Ω–∏–µ, —Å–¥–µ–ª–∫–∏, –ø—Ä–æ–≤–∞–ª—ã, –∫–æ–º–ø—Ä–æ–º–∏—Å—Å—ã, –Ω–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏."></textarea>
              </label>
            </div>
          </div>

          <div style="grid-column:1/-1; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn btn--primary" id="saveBtn" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
            <a class="btn btn--ghost" href="characters/index.html">–û—Ç–∫—Ä—ã—Ç—å —Å–æ—Å—Ç–∞–≤</a>
            <a class="btn btn--ghost" id="openPublic" href="#" hidden>–û—Ç–∫—Ä—ã—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>
          </div>
        </form>
      </div>
    </section>

    <footer class="footer">
      <div class="wrap footer__inner">
        <div>Ballas ‚Ä¢ Profile</div>
        <button class="btn btn--ghost" id="themeBtn2" type="button">–¢–µ–º–∞</button>
      </div>
    </footer>
  </main>

  <button class="btn btn--primary toTop" id="toTop" type="button" aria-label="–ù–∞–≤–µ—Ä—Ö">‚Üë –ù–∞–≤–µ—Ä—Ö</button>

  <script type="module" src="./auth-ui.js"></script>

  <script src="script.js"></script>

  <script type="module">
    import { isDemoMode, getDemoUser, getDemoCharacterByUid, upsertDemoCharacter } from './demo-store.js';

    const DEMO = isDemoMode();

    let auth = null, db = null, storage = null;
    let onAuthStateChanged = null;
    let doc = null, getDoc = null, setDoc = null, serverTimestamp = null;
    let ref = null, uploadBytes = null, getDownloadURL = null;

    if (!DEMO) {
      const cfg = await import('./firebase-config.js');
      auth = cfg.auth; db = cfg.db; storage = cfg.storage;
      const authMod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
      onAuthStateChanged = authMod.onAuthStateChanged;
      const fsMod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
      doc = fsMod.doc; getDoc = fsMod.getDoc; setDoc = fsMod.setDoc; serverTimestamp = fsMod.serverTimestamp;
      const stMod = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js');
      ref = stMod.ref; uploadBytes = stMod.uploadBytes; getDownloadURL = stMod.getDownloadURL;
    } else {
      // Minimal Firestore-like wrappers for demo mode
      doc = (_db, _col, id) => ({ id });
      getDoc = async (d) => {
        const obj = getDemoCharacterByUid(d.id);
        return { exists: () => !!obj, data: () => obj };
      };
      setDoc = async (d, payload, _opts) => {
        upsertDemoCharacter(d.id, payload);
      };
      serverTimestamp = () => new Date().toISOString();
      onAuthStateChanged = (_auth, cb) => cb(getDemoUser() ? { uid: getDemoUser().uid, email: getDemoUser().email } : null);
    }

    const $ = (id) => document.getElementById(id);
    const statusNote = $('statusNote');
    const form = $('profileForm');
    const openPublic = $('openPublic');
    const photoInput = $('photo');
    const photoPreview = $('photoPreview');

    let currentUid = null;
    let currentSlug = null;
    let hasExisting = false;

    // Slug that works with Cyrillic + Latin names.
    // Keep letters/digits (incl. \u0400-\u04FF), replace spaces with '-', collapse dashes.
    function slugify(s){
      const base = (s || '').trim().toLowerCase();
      return base
        .replace(/[^0-9a-z\u0400-\u04FF\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function ageAt(d){
      if (!d) return null;
      const dob = new Date(d);
      const now = new Date();
      let age = now.getFullYear() - dob.getFullYear();
      const m = now.getMonth() - dob.getMonth();
      if (m < 0 || (m === 0 && now.getDate() < dob.getDate())) age--;
      return age;
    }

    photoInput.addEventListener('change', () => {
      const f = photoInput.files && photoInput.files[0];
      if (!f) { photoPreview.innerHTML=''; return; }
      const url = URL.createObjectURL(f);
      photoPreview.innerHTML = `<img alt="–ü—Ä–µ–≤—å—é" src="${url}" style="width:160px; height:160px; object-fit:cover; border-radius:14px; border:1px solid var(--line)" />`;
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) return;

      currentUid = user.uid;
      // Load existing character (one account = one character)
      let snap = null;
      try {
        const refDoc = doc(db, 'characters', user.uid);
        snap = await getDoc(refDoc);
      } catch (e) {
        console.error('Firestore getDoc failed:', e);
        const code = e?.code || '';
        const hint = (code === 'permission-denied')
          ? '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Firestore. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞: —á—Ç–µ–Ω–∏–µ –≤—Å–µ–º, –∑–∞–ø–∏—Å—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–º—É uid.'
          : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –±–∞–∑—ã. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø—Ä–∞–≤–∏–ª–∞ Firestore.';
        statusNote.textContent = hint;
        return;
      }

      hasExisting = snap.exists();
      if (hasExisting) {
        const data = snap.data();
        const [firstName, lastName] = String(data.name || '').split(' ');
        $('firstName').value = firstName || '';
        $('lastName').value = lastName || '';
        $('alias').value = data.alias || '';
        $('dob').value = data.dob || '';
        $('tags').value = (data.tags || []).join(', ');

        const rp = data.rp || {};
        $('preface').value = rp.preface || '';
        $('historyStart').value = rp.historyStart || '';
        $('historyMiddle').value = rp.historyMiddle || '';
        $('bridge').value = rp.bridge || '';
        $('devPre2026').value = rp.devPre2026 || '';
        $('dev2026').value = rp.dev2026 || '';
        $('plotStart2026').value = rp.plotStart2026 || '';
        $('morality').value = rp.morality || '';
        $('tasks').value = rp.tasks || '';
        $('message').value = rp.message || '';
        $('funding').value = rp.funding || '';
        $('cops').value = rp.cops || '';
        $('climax').value = rp.climax || '';
        $('ops2026').value = rp.ops2026 || '';

        if (data.photoUrl) {
          photoPreview.innerHTML = `<img alt="–§–æ—Ç–æ" src="${data.photoUrl}" style="width:160px; height:160px; object-fit:cover; border-radius:14px; border:1px solid var(--line)" />`;
        }

        currentSlug = data.slug || null;
        if (currentSlug) {
          openPublic.hidden = false;
          openPublic.href = `person.html?slug=${encodeURIComponent(currentSlug)}`;
        }

        statusNote.textContent = '–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω. –ú–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å.';
      } else {
        statusNote.textContent = '–ü—Ä–æ—Ñ–∏–ª—å –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω. –ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å¬ª.';
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const first = $('firstName').value.trim();
      const last = $('lastName').value.trim();
      const dob = $('dob').value;

      const age = ageAt(dob);
      if (age == null || age < 18) {
        alert('–ü–µ—Ä—Å–æ–Ω–∞–∂ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 18+');
        return;
      }

      const name = `${first} ${last}`.trim();
      const alias = $('alias').value.trim();
      const tags = $('tags').value
        .split(',')
        .map(s => s.trim().toLowerCase())
        .filter(Boolean)
        .slice(0, 20);

      const rp = {
        preface: $('preface').value.trim(),
        historyStart: $('historyStart').value.trim(),
        historyMiddle: $('historyMiddle').value.trim(),
        bridge: $('bridge').value.trim(),
        devPre2026: $('devPre2026').value.trim(),
        dev2026: $('dev2026').value.trim(),
        plotStart2026: $('plotStart2026').value.trim(),
        morality: $('morality').value.trim(),
        tasks: $('tasks').value.trim(),
        message: $('message').value.trim(),
        funding: $('funding').value.trim(),
        cops: $('cops').value.trim(),
        climax: $('climax').value.trim(),
        ops2026: $('ops2026').value.trim(),
      };

      // If the name is fully non-latin/non-cyrillic or empty, fall back to uid.
      const slug = slugify(name) || `uid-${String(currentUid || '')}`;

      let photoUrl = null;
      const file = photoInput.files && photoInput.files[0];
      if (file) {
        if (DEMO) {
          // GitHub Pages demo mode: store image as DataURL in localStorage (small files only).
          photoUrl = await new Promise((resolve) => {
            const r = new FileReader();
            r.onload = () => resolve(String(r.result || ''));
            r.onerror = () => resolve(null);
            r.readAsDataURL(file);
          });
          if (!photoUrl) alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç/—Ñ–∞–π–ª.');
        } else {
          try {
            const ext = (file.name || '').split('.').pop() || 'jpg';
            const pRef = ref(storage, `photos/${currentUid}.${ext}`);
            await uploadBytes(pRef, file, { contentType: file.type || 'image/jpeg' });
            photoUrl = await getDownloadURL(pRef);
          } catch (e) {
            const code = e?.code || '';
            const hint = (code === 'storage/unauthorized')
              ? '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Storage. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞ Storage (—Ä–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º) –∏ —á—Ç–æ –¥–æ–º–µ–Ω —Å–∞–π—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω –≤ Authorized domains.'
              : (code === 'storage/canceled')
                ? '–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.'
                : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª–∞ Storage –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';
            alert(hint);
          }
        }
      }

      const payload = {
        uid: currentUid,
        name,
        alias,
        dob,
        tags,
        slug,
        set: 'Davis',
        role: 'Member',
        photoUrl: photoUrl || undefined,
        rp,
        updatedAt: serverTimestamp(),
        ...(hasExisting ? {} : { createdAt: serverTimestamp() }),
      };

      // Keep existing photoUrl if user didn't upload a new one.
      if (!photoUrl) delete payload.photoUrl;

      try {
        await setDoc(doc(db, 'characters', currentUid), payload, { merge: true });
      } catch (e) {
        console.error('Firestore setDoc failed:', e);
        const code = e?.code || '';
        const hint = (code === 'permission-denied')
          ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º–∏ Firestore. –í Rules –Ω—É–∂–Ω–æ: read: true; write: —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–º—É uid.'
          : (code === 'unauthenticated')
            ? '–ù—É–∂–Ω–æ –±—ã—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º. –ü–µ—Ä–µ–∑–∞–π–¥–∏ –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.'
            : (code === 'unavailable')
              ? 'Firestore –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å —Å–µ—Ç—å/VPN –∏ –ø–æ–≤—Ç–æ—Ä–∏.'
              : '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø—Ä–∞–≤–∏–ª–∞ Firestore.';
        alert(hint);
        statusNote.textContent = hint;
        return;
      }

      currentSlug = slug;
      openPublic.hidden = false;
      openPublic.href = `person.html?slug=${encodeURIComponent(slug)}`;

      statusNote.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω –∏ —É–∂–µ –≤ —Å–æ—Å—Ç–∞–≤–µ.';
      alert('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    });
  </script>
</body>
</html>
